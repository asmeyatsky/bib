name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

# -----------------------------------------------------------------------------
# Shared Services Configuration
# -----------------------------------------------------------------------------
env:
  GO_VERSION: "1.24"
  GOLANGCI_LINT_VERSION: v1.64.8

jobs:
  # ---------------------------------------------------------------------------
  # Change Detection - Only skip on PRs, always run on push to main
  # ---------------------------------------------------------------------------
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      pkg: ${{ steps.filter.outputs.pkg }}
      gateway: ${{ steps.filter.outputs.gateway }}
      services: ${{ steps.filter.outputs.services }}
      any-service: ${{ steps.filter.outputs.any-service || github.event_name == 'push' }}
      ci: ${{ steps.filter.outputs.ci }}
      force-run: ${{ github.event_name == 'push' }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            pkg:
              - 'pkg/**'
              - 'go.work'
              - 'go.work.sum'
            gateway:
              - 'gateway/**'
              - 'pkg/**'
            services:
              - 'services/**'
              - 'pkg/**'
              - 'go.work'
              - 'go.work.sum'
            any-service:
              - 'services/**'
              - 'gateway/**'
              - 'pkg/**'
              - 'go.work'
              - 'go.work.sum'
            ci:
              - '.github/workflows/**'
              - 'Makefile'
              - '.golangci.yml'

  # ---------------------------------------------------------------------------
  # Global Lint - Runs once across all modules
  # ---------------------------------------------------------------------------
  lint:
    name: Lint
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: detect-changes
    if: >
      needs.detect-changes.outputs.force-run == 'true' ||
      needs.detect-changes.outputs.any-service == 'true' ||
      needs.detect-changes.outputs.ci == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: |
            **/go.sum
            go.work.sum
      - name: Install golangci-lint
        run: go install github.com/golangci/golangci-lint/cmd/golangci-lint@${{ env.GOLANGCI_LINT_VERSION }}
      - name: Run linters per module
        run: make lint
        env:
          GOGC: 50

  # ---------------------------------------------------------------------------
  # Unit Tests - Parallel by Service
  # ---------------------------------------------------------------------------
  test-services:
    name: Test ${{ matrix.service }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [detect-changes, lint]
    if: >
      needs.detect-changes.outputs.force-run == 'true' ||
      needs.detect-changes.outputs.services == 'true'
    strategy:
      fail-fast: false
      matrix:
        service:
          - ledger-service
          - account-service
          - fx-service
          - deposit-service
          - identity-service
          - payment-service
          - lending-service
          - fraud-service
          - card-service
          - reporting-service
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: bib
          POSTGRES_PASSWORD: bib_test_password
          POSTGRES_DB: bib_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: |
            **/go.sum
            go.work.sum
      - name: Run unit tests
        run: |
          cd services/${{ matrix.service }}
          go test -race -coverprofile=coverage.out -covermode=atomic ./...
      - name: Run integration tests
        run: |
          cd services/${{ matrix.service }}
          go test -race -tags=integration ./...
        env:
          TEST_DB_HOST: localhost
          TEST_DB_PORT: 5432
          TEST_DB_USER: bib
          TEST_DB_PASSWORD: bib_test_password
          TEST_DB_NAME: bib_test
          TEST_DB_SSLMODE: disable
      - name: Upload coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-${{ matrix.service }}
          path: services/${{ matrix.service }}/coverage.out
          retention-days: 7

  # ---------------------------------------------------------------------------
  # Gateway Tests
  # ---------------------------------------------------------------------------
  test-gateway:
    name: Test Gateway
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [detect-changes, lint]
    if: >
      needs.detect-changes.outputs.force-run == 'true' ||
      needs.detect-changes.outputs.gateway == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: |
            **/go.sum
            go.work.sum
      - name: Run gateway tests
        run: |
          cd gateway
          go test -race -coverprofile=coverage.out -covermode=atomic ./...

  # ---------------------------------------------------------------------------
  # Package Tests (if pkg/ changed)
  # ---------------------------------------------------------------------------
  test-pkgs:
    name: Test Packages
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [detect-changes, lint]
    if: >
      needs.detect-changes.outputs.force-run == 'true' ||
      needs.detect-changes.outputs.pkg == 'true'
    strategy:
      fail-fast: false
      matrix:
        pkg:
          - money
          - events
          - auth
          - kafka
          - postgres
          - observability
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: |
            **/go.sum
            go.work.sum
      - name: Test ${{ matrix.pkg }}
        run: |
          cd pkg/${{ matrix.pkg }}
          go test -race -coverprofile=coverage.out ./...

  # ---------------------------------------------------------------------------
  # Docker Build - Matrix Parallel Builds
  # ---------------------------------------------------------------------------
  docker-build:
    name: Build ${{ matrix.service }} Image
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [test-services, test-gateway, test-pkgs]
    if: >
      always() &&
      (needs.test-services.result == 'success' || needs.test-services.result == 'skipped') &&
      (needs.test-gateway.result == 'success' || needs.test-gateway.result == 'skipped') &&
      (needs.test-pkgs.result == 'success' || needs.test-pkgs.result == 'skipped')
    strategy:
      fail-fast: false
      matrix:
        service:
          - ledger-service
          - account-service
          - fx-service
          - deposit-service
          - identity-service
          - payment-service
          - lending-service
          - fraud-service
          - card-service
          - reporting-service
          - gateway
    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build ${{ matrix.service }}
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ matrix.service == 'gateway' && 'gateway/Dockerfile' || format('services/{0}/Dockerfile', matrix.service) }}
          push: false
          tags: bib-${{ matrix.service }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            GOCACHE=/go/.cache
            GOMODCACHE=/go/.modcache

  # ---------------------------------------------------------------------------
  # E2E Tests - Full Stack
  # ---------------------------------------------------------------------------
  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: docker-build
    if: always() && needs.docker-build.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build and start full stack
        run: docker compose up -d --build
        timeout-minutes: 25
      - name: Wait for all services to be healthy
        run: |
          echo "Waiting for all services to become healthy..."
          for i in {1..120}; do
            healthy_count=0
            for port in 8081 8082 8083 8084 8085 8086 8087 8088 8089 8090 8080; do
              if curl -sf --max-time 2 http://localhost:$port/healthz > /dev/null 2>&1; then
                healthy_count=$((healthy_count + 1))
              fi
            done
            echo "Attempt $i: $healthy_count/11 services healthy"
            if [ $healthy_count -eq 11 ]; then
              echo "All services are healthy!"
              exit 0
            fi
            sleep 3
          done
          echo "Services did not become healthy in time"
          echo "=== Service Status ==="
          docker compose ps
          echo "=== Gateway Logs ==="
          docker compose logs --tail=50 gateway
          echo "=== Ledger Service Logs ==="
          docker compose logs --tail=50 ledger-service
          exit 1
      - name: Functional readiness probe
        run: |
          echo "Verifying full stack is functionally ready..."
          for i in {1..10}; do
            status=$(curl -s -o /dev/null -w '%{http_code}' --max-time 5 \
              -X POST http://localhost:8080/api/v1/identity/verifications \
              -H 'Content-Type: application/json' \
              -d '{"type":"email","contact":"readiness@test.com"}' || true)
            echo "Readiness probe attempt $i: HTTP $status"
            if [ "$status" = "200" ] || [ "$status" = "201" ] || [ "$status" = "400" ] || [ "$status" = "401" ] || [ "$status" = "409" ]; then
              echo "Stack is functionally ready (got a real response)."
              break
            fi
            sleep 3
          done
      - name: Run E2E tests
        run: make test-e2e
        env:
          GATEWAY_URL: http://localhost:8080
          JWT_SECRET: test-e2e-secret
      - name: Dump logs on failure
        if: failure()
        run: |
          echo "=== All Service Logs ==="
          docker compose logs --tail=100
      - name: Cleanup
        if: always()
        run: docker compose down -v

  # ---------------------------------------------------------------------------
  # Security Scanning - Independent, non-blocking
  # ---------------------------------------------------------------------------
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [detect-changes, docker-build]
    if: always() && needs.docker-build.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: |
            **/go.sum
            go.work.sum
      - name: Run Trivy filesystem scan
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
          trivy fs --severity CRITICAL,HIGH --exit-code 0 --format table . || true
      - name: Install and run gosec
        run: |
          go install github.com/securego/gosec/v2/cmd/gosec@latest
          for dir in services/*/; do
            echo "=== Scanning $dir ==="
            (cd "$dir" && gosec ./...) || true
          done
          echo "=== Scanning gateway ==="
          (cd gateway && gosec ./...) || true
